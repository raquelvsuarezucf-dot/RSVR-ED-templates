<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RVSRED Templates — Local</title>
  <meta name="description" content="Emergency Medicine documentation templates — No PHI stored.">
  <meta name="theme-color" content="#1E70C1" />
  <meta name="color-scheme" content="light" />

  <!-- Compact, URI-encoded SVG favicon (no external file) -->
  <link rel="icon" type="image/svg+xml" 
    href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"%3E%3Cdefs%3E%3ClinearGradient id="g" x1="0" x2="0" y1="0" y2="1"%3E%3Cstop offset="0%25" stop-color="%231E70C1"/%3E%3Cstop offset="100%25" stop-color="%233A8BE0"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x="4" y="4" width="56" height="56" rx="14" fill="url(%23g)"/%3E%3Cg fill="%23fff" font-family="system-ui,-apple-system,Segoe UI,Roboto,Arial" font-weight="800" font-size="28"%3E%3Ctext x="32" y="40" text-anchor="middle"%3ERVS%3C/text%3E%3C/g%3E%3C/svg%3E' />

  <style>
    :root{
      --bg:#eaf1fb; --bg2:#dbe7f6; --panel:#fff; --border:#cfe0f5;
      --primary:#1E70C1; --primary2:#3A8BE0; --text:#0f2640; --muted:#5b6b84;
      --radius:16px; --shadow:0 8px 28px rgba(15,38,64,.08);
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .hidden{display:none!important}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#e6effd);border-bottom:1px solid var(--border);padding-top:env(safe-area-inset-top)}
    .toolbar{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input,textarea,.btn,select{font:inherit}
    .input,textarea,select{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;color:var(--text)}
    .btn{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary2));color:#fff;border-color:transparent;font-weight:700}
    .layout{display:grid;grid-template-columns:280px 1fr;gap:16px}

    /* Sidebar */
    .sidebar{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}
    .side-title{font-weight:800;margin:2px 0 8px}
    .cat,.sub{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:6px 0;background:#fbfdff;cursor:pointer;user-select:none;transition:background .15s ease,border-color .15s ease}
    .cat{border-color:#cfe0f5;background:#fbfdff}
    .sub{border-color:#cfe0f5;background:#fbfdff}
    .cat[data-color]{border-color:color-mix(in srgb,var(--cat-color,#cfe0f5),#000 8%);background:color-mix(in srgb,var(--cat-color,#cfe0f5),#fff 86%)}
    .sub[data-color]{border-color:color-mix(in srgb,var(--cat-color,#cfe0f5),#000 8%);background:color-mix(in srgb,var(--cat-color,#cfe0f5),#fff 92%)}
    .cat.active,.sub.active{outline:3px solid #8AC0FF;background:#f0f7ff}
    .groupHead{display:flex;align-items:center;gap:10px}
    .caret{font-size:14px;opacity:.8;transition:transform .2s ease}
    .subs{margin-left:10px;overflow:hidden;transition:max-height .22s ease}
    .subs.closed{max-height:0}
    .subs.open{max-height:1000px}
    .badge{font-size:12px;background:#eaf2ff;border:1px solid var(--border);border-radius:999px;padding:2px 8px}

    /* Cards */
    .list{display:grid;gap:16px}
    .card{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .15s ease, transform .15s ease}
    @media (hover:hover){ .card:hover{ box-shadow:0 10px 34px rgba(15,38,64,.12) } }
    .card[data-color] .card-head{
      background:linear-gradient(135deg,color-mix(in srgb,var(--cat-color,#9ab7e6),#ffffff 70%) 0%,color-mix(in srgb,var(--cat-color,#9ab7e6),#ffffff 85%) 100%);
      height:36px;border-top-left-radius:10px;border-top-right-radius:10px;display:block;padding:0;box-shadow:inset 0 1px 0 rgba(255,255,255,.5),0 2px 4px rgba(0,0,0,.05)
    }
    .card-body{padding:16px}
    .title{font-weight:800;margin:0 0 6px;font-size:1rem}
    .small{font-size:13.5px;color:#5b6b84}
    .alias{color:var(--primary);font-weight:800}

    /* Paragraph body */
    .macro-body{font-size:15px;color:#1d3657;background:#fafcff;border:1px dashed #e1ecfb;border-radius:12px;padding:12px;max-height:240px;overflow:auto;margin:8px 0 0}
    .macro-body p{margin:0 0 14px}
    .macro-body p:last-child{margin-bottom:0}
    mark{background:#fff3a1;padding:0 .12em;border-radius:4px}
    .hl{outline:3px solid #8AC0FF;transition:outline-color .6s ease}

    /* Login + dialogs + settings */
    .center{display:grid;place-items:center;min-height:100dvh;padding:24px}
    .login{background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px;width:min(620px,96vw)}
    .muted{color:#5b6b84}
    dialog{border:none;border-radius:16px;padding:0;max-width:min(860px,96vw)}
    dialog .content{padding:16px}
    .actions{display:flex;gap:10px;justify-content:flex-end}
    .settings-grid{display:grid;grid-template-columns:1fr 140px 120px 110px;gap:8px;align-items:center}
    .settings-grid .hdr{font-weight:700;font-size:14px;color:#2a3b55}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#f7faff}
    .danger{background:#ffe9e8;border-color:#ffc8c4;color:#7f1d1d}
    .soft{opacity:.8}

    /* Accessibility */
    :focus-visible{ outline:3px solid #8AC0FF; outline-offset:2px }
    main{ outline:none }

    @media (max-width:900px){
      .layout{grid-template-columns:1fr;gap:12px}
      .sidebar{border-radius:12px;padding:10px}
      .toolbar{gap:10px}
      #search{flex:1;min-width:0;width:100%;height:44px;font-size:16px}
      #prevBtn,#nextBtn,#newBtn,#settingsBtn{height:40px;padding:8px 12px}
      .card{border-radius:12px}
      .card-body{padding:14px}
      .title{font-size:.98rem;line-height:1.25}
      .macro-body{font-size:14.5px;max-height:40vh}
      #hitCount{min-width:auto}
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto!important;transition:none!important;animation:none!important}
    }
  </style>
</head>

<body>
  <!-- Login -->
  <div id="login" class="center">
    <div class="login" role="form" aria-labelledby="loginTitle">
      <h1 id="loginTitle" style="margin:0 0 8px">RVSRED Templates — Authorized Access Only</h1>
      <p class="muted" style="margin:0 0 12px">Emergency Medicine Documentation Utility — No PHI stored.</p>
      <label class="small" for="u">Username</label>
      <input id="u" class="input" autocomplete="off" inputmode="text" />
      <div style="height:8px"></div>
      <label class="small" for="p">Password</label>
      <input id="p" type="password" class="input" />
      <div style="height:12px"></div>
      <button id="loginBtn" class="btn primary" style="width:100%" type="button">Sign in</button>
      <p id="err" class="small" style="color:#b3261e;margin-top:10px" role="alert"></p>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden" aria-hidden="true">
    <header>
      <div class="wrap toolbar">
        <div class="row" style="flex:1">
          <input id="search" class="input" type="search" aria-label="Search templates"
                 placeholder="Search…  (Enter = Next • Shift+Enter = Prev • .alias = Copy & Show)" />
          <button id="prevBtn" class="btn" title="Previous result" aria-label="Previous result" type="button">Prev</button>
          <button id="nextBtn" class="btn" title="Next result" aria-label="Next result" type="button">Next</button>
          <span id="hitCount" class="small" style="min-width:80px;text-align:center;color:#2a3b55" aria-live="polite"></span>
        </div>
        <div class="row">
          <button id="newBtn" class="btn" aria-label="New macro" type="button">New</button>
          <button id="settingsBtn" class="btn" title="Manage categories" aria-haspopup="dialog" type="button">⚙️ Settings</button>
          <button id="logoutBtn" class="btn" aria-label="Logout" type="button">Logout</button>
        </div>
      </div>
    </header>

    <div class="wrap layout">
      <aside class="sidebar" aria-label="Categories" role="complementary">
        <div class="side-title">Categories</div>
        <div id="cats"></div>
      </aside>
      <main role="main">
        <div id="list" class="list"></div>
      </main>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden" role="status" aria-live="polite" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f2640;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2)">Copied</div>

  <!-- Editor -->
  <dialog id="editor" aria-label="Macro editor">
    <div class="content">
      <h3 id="edTitle" style="margin:0 0 8px">Edit Macro</h3>
      <div class="row" style="align-items:flex-start">
        <div style="flex:1;min-width:180px">
          <label class="small" for="fGroup">Category (Group) *</label>
          <select id="fGroup" class="input"></select>
        </div>
        <div style="flex:1;min-width:180px">
          <label class="small" for="fSub">Subgroup *</label>
          <input id="fSub" class="input" list="subOptions" placeholder="e.g., URI, Asthma, Sign-Out" />
          <datalist id="subOptions"></datalist>
        </div>
      </div>
      <div style="height:6px"></div>
      <label class="small" for="fTitle">Title *</label>
      <input id="fTitle" class="input" />
      <div style="height:6px"></div>

      <label class="small" for="fAliasSuffix">Alias (dot-phrase uses this)</label>
      <div class="aliasRow" style="display:flex;gap:8px;align-items:center">
        <span id="aliasPrefix" class="prefix" style="display:inline-block;min-width:68px;text-align:center;background:#eef5ff;border:1px solid var(--border);padding:8px 10px;border-radius:10px">.peds</span>
        <input id="fAliasSuffix" class="input" placeholder="e.g., viral  → .pedsviral" />
      </div>

      <div style="height:6px"></div>
      <label class="small" for="fBody">Body</label>
      <textarea id="fBody" rows="12" class="input" style="height:260px"></textarea>
      <div class="actions" style="margin-top:10px">
        <button id="dupBtn" class="btn" title="Duplicate (Ctrl/⌘+D)" type="button">Duplicate</button>
        <button id="delBtn" class="btn danger" title="Delete" type="button">Delete</button>
        <button id="saveBtn" class="btn primary" title="Save (Ctrl/⌘+S)" type="button">Save</button>
        <button id="closeEd" class="btn" title="Close (Esc)" type="button">Close</button>
      </div>
    </div>
  </dialog>

  <!-- Settings -->
  <dialog id="settings" aria-label="Settings">
    <div class="content">
      <h3 style="margin:0 0 10px">Manage Categories</h3>
      <div class="settings-grid soft" role="table" aria-label="Category list">
        <div class="hdr" role="columnheader">Category</div>
        <div class="hdr" role="columnheader">Prefix</div>
        <div class="hdr" role="columnheader">Color</div>
        <div class="hdr" role="columnheader">Actions</div>
      </div>
      <div id="catRows" style="display:grid;gap:8px;margin:8px 0 12px"></div>
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="addCatBtn" class="btn" type="button">+ Add Category</button>
          <button id="backupBtn" class="btn" title="Download macros + categories" type="button">Download Backup</button>
        </div>
        <div class="row">
          <span class="pill">Changes save instantly</span>
          <button id="closeSettings" class="btn" type="button">Close</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Initial Macros -->
  <script type="application/json" id="initial-macros">[
    {"group":"Pediatrics","sub":"URI","title":"MDM — Pediatric Viral / Febrile Illness","alias":"pedsviral","body":"[age]-year-old [sex] presented to the ED with [duration] of fever and associated [symptoms: cough, nasal congestion, rhinorrhea, decreased appetite, irritability].\n\nParent present at bedside reports the patient has been tolerating PO without difficulties, with [no / mild] decrease in appetite and normal urine output. Denies vomiting, diarrhea, rash, or respiratory distress. Immunizations are up to date.\n\nOn evaluation, patient appeared well hydrated, interactive, and appropriate for age, with normal capillary refill and no increased work of breathing. Oropharynx clear, tympanic membranes without bulging or erythema, lungs clear to auscultation, and abdomen soft, non-tender, and non-distended.\n\nDifferential includes viral upper respiratory infection, early otitis media, influenza, RSV, COVID-19, and early pneumonia, though there were no focal findings to strongly suggest a bacterial source. Findings today are most consistent with a viral process.\n\n[COVID, influenza, and RSV tests were negative / pending / positive for ___ / not obtained.]\n\nPatient remained comfortable and interactive throughout the ED visit with stable vital signs and reassuring physical findings. Findings reviewed with the parent at bedside, and supportive care discussed, including weight-based acetaminophen or ibuprofen for fever and encouraging fluids as tolerated.\n\nParent verbalized understanding and was comfortable with the plan for discharge and outpatient follow-up. Strict return precautions discussed, including persistent fever, respiratory distress, poor oral intake, vomiting, decreased urine output, new rash, or any new or concerning symptoms. Follow-up with pediatrician advised within 48–72 hours or sooner if symptoms worsen."},
    {"group":"Pediatrics","sub":"URI","title":"MDM — Pediatric Streptococcal Pharyngitis","alias":"pedspharyn","body":"[age]-year-old [sex] presented to the ED with [duration] of sore throat associated with [symptoms: fever, decreased appetite, odynophagia, mild cough / no cough, nasal congestion].\n\nParent reports the patient has been tolerating PO intake [well / poorly] and maintaining normal urine output. Denies vomiting, drooling, neck stiffness, or respiratory distress. Immunizations are up to date.\n\nOn exam, the patient appeared well hydrated, interactive, and nontoxic. Oropharyngeal exam notable for [tonsillar erythema / exudates / palatal petechiae / none]; uvula midline; no evidence of peritonsillar swelling or trismus. Cervical nodes [tender / non-tender, enlarged / not enlarged]. Lungs clear to auscultation; no meningeal signs or rash observed.\n\nDifferential includes streptococcal pharyngitis, viral pharyngitis, early tonsillitis, and mononucleosis, with low concern for peritonsillar abscess, epiglottitis, or retropharyngeal infection given a reassuring airway exam and overall well appearance. Findings today are most consistent with [streptococcal / viral] pharyngitis.\n\n[Rapid strep test positive / negative / pending; throat culture sent / not obtained.] [COVID, influenza, and RSV tests negative / positive for ___ / not obtained.]\n\nFor confirmed or suspected streptococcal infection, prescribed [amoxicillin / cephalexin / azithromycin] — weight-based dosing — with instructions to complete the full course. Supportive care discussed, including acetaminophen or ibuprofen for fever or throat pain, maintaining hydration, and soft foods as tolerated.\n\nPatient remained comfortable and interactive throughout the ED visit with stable vital signs and reassuring physical findings. Parent was comfortable with discharge and outpatient follow-up. Strict return precautions discussed, including persistent fever, worsening throat pain, drooling, difficulty swallowing or breathing, neck swelling, or any new or concerning symptoms. Follow-up with pediatrician within 48–72 hours or sooner if symptoms worsen."},
    {"group":"Pediatrics","sub":"URI","title":"MDM — Pediatric Otitis Media","alias":"pedsom","body":"[age]-year-old [sex] presented to the ED with [duration] of ear pain associated with [symptoms: fever, nasal congestion, cough, irritability, decreased appetite].\n\nParent reports PO intake [well / poorly] with normal urinary output. Denies vomiting, drainage from the ear, rash, or respiratory distress. Immunizations up to date.\n\nOn exam, patient appeared well hydrated and interactive for age. Right / left tympanic membrane noted to be [erythematous / bulging / dull / effusion present / normal]. No mastoid tenderness, auricular swelling, or drainage. Contralateral ear within normal limits. Lungs clear; oropharynx without erythema or exudate. Neck supple with full ROM; no lymphadenopathy. Abdomen soft and non-tender.\n\nDifferential includes acute otitis media, otitis externa, eustachian tube dysfunction, and viral upper respiratory infection. Findings today are most consistent with [acute otitis media / serous otitis / viral URI with referred ear pain].\n\n[COVID, influenza, and RSV tests negative / positive for ___ / not obtained.]\n\nIf bacterial: Antibiotic therapy initiated with [amoxicillin / cefdinir / azithromycin], weight-based, and first dose given in the ED. Supportive care discussed with parent, including acetaminophen or ibuprofen for pain or fever, and maintaining hydration. If symptoms fail to improve or worsen despite treatment, advised prompt re-evaluation.\n\nIf non-bacterial / watchful waiting: Findings reviewed with parent at bedside. Presentation may represent early or serous otitis rather than acute bacterial infection; advised supportive care with acetaminophen or ibuprofen as needed and close follow-up if symptoms persist or worsen.\n\nPatient remained comfortable and interactive throughout the ED visit with stable vital signs and reassuring physical findings. Findings and plan reviewed with parent at bedside, who verbalized understanding and was comfortable with discharge and outpatient follow-up. Strict return precautions discussed, including persistent fever, worsening ear pain, drainage from the ear, vomiting, lethargy, poor oral intake, new rash, neck stiffness, or any new or concerning symptoms. Follow-up with pediatrician advised within 48–72 hours or sooner if symptoms worsen."},
    {"group":"Pediatrics","sub":"URI","title":"MDM — Pediatric Pneumonia","alias":"pedspna","body":"[age]-year-old [sex] presented to the ED with [duration] of [cough / fever / shortness of breath / malaise].\n\nParent present at bedside reports [persistent cough / decreased appetite / mild fatigue / increased work of breathing] with [no vomiting / no lethargy / no rash]. On exam, patient was alert, interactive, and behaving appropriately for age.\n\nLungs revealed [focal crackles / diminished breath sounds / rhonchi / mild wheezing], with [no retractions / no nasal flaring / normal oxygen saturation]. Findings otherwise reassuring, with no signs of respiratory distress or dehydration.\n\nDifferential includes viral pneumonia, bacterial pneumonia, bronchiolitis, asthma or reactive airway exacerbation, and upper respiratory infection. Findings today are most consistent with [bacterial / viral] pneumonia based on clinical picture and [chest x-ray results / auscultatory findings].\n\nPatient was [prescribed / given] [amoxicillin / azithromycin / cefdinir], weight-based, for outpatient treatment. Supportive care discussed with parent at bedside, including acetaminophen or ibuprofen for fever control and encouraging fluids as tolerated. [Continued with prescribed albuterol as needed.]\n\nParent verbalized understanding and was comfortable with the plan for discharge and follow-up. Return precautions discussed, including worsening or persistent fever, increased work of breathing, chest pain, vomiting, lethargy, poor oral intake, cyanosis, or any new or concerning symptoms. Follow-up with pediatrician advised within 48–72 hours or sooner if symptoms worsen."},
    {"group":"ED Communication","sub":"Sign-Out","title":"Sign-Out — Giving","alias":"signoutgive","body":"Patient signed out to [Dr. _____] at [time] with pending [labs / imaging / re-evaluation].\n\nClinical course and current status reviewed in detail. Disposition options discussed and plan of care conveyed to the receiving provider, who will follow pending results and determine final disposition.\n\nPatient remained stable at time of sign-out."},
    {"group":"ED Communication","sub":"Sign-Out","title":"Sign-Out — Receiving","alias":"signoutrecv","body":"Patient received in sign-out from [Dr. _____] at [time] with pending [results / re-evaluation / consults].\n\nPrior ED course, findings, and disposition considerations reviewed. Assuming ongoing care and final disposition."}
  ]</script>

  <!-- App code (no external calls, no Firebase/CDN) -->
  <script>
  (() => {
    const $ = s => document.querySelector(s);

    const listEl = $("#list"), searchEl = $("#search"), catsEl = $("#cats"),
          toastEl = $("#toast"), settingsDlg = $("#settings"), editorDlg = $("#editor"),
          prevBtn = $("#prevBtn"), nextBtn = $("#nextBtn"), newBtn = $("#newBtn"),
          settingsBtn = $("#settingsBtn"), logoutBtn=$("#logoutBtn"), hitCount = $("#hitCount"),
          backupBtn = $("#backupBtn");

    // Local-only keys
    const LKEY="rvsred-macros", EXPKEY="rvsred-expanded", CKEY="rvsred-categories";
    const SESSION_KEY = "rvsred-loggedin::local"; // persistent login, no password on refresh
    const LOGIN_USER="EDtemplates", LOGIN_PASS="odynophagia";

    const rid=()=>crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2);
    const toast = t => { toastEl.textContent=t; toastEl.classList.remove("hidden"); setTimeout(()=>toastEl.classList.add("hidden"),1600); };

    /* ---------- Categories helpers ---------- */
    function defaultCategories(){ return {"Pediatrics":{color:"#1E70C1",prefix:"peds"},"ED Communication":{color:"#6C5CE7",prefix:"edc"},"Other":{color:"#9ab7e6",prefix:"other"}}; }
    function getCategoriesLocal(){ try{ return JSON.parse(localStorage.getItem(CKEY)) || defaultCategories(); } catch{ return defaultCategories(); } }
    function setCategoriesLocal(map){ localStorage.setItem(CKEY, JSON.stringify(map)); }
    let categories = getCategoriesLocal();
    const colorForGroup = g => (categories[g]?.color)||"#9ab7e6";
    const prefixForGroup = g => (categories[g]?.prefix)||"other";

    function showApp(){
      $("#login").classList.add("hidden");
      $("#app").classList.remove("hidden");
      $("#app").setAttribute("aria-hidden","false");
      boot();
      searchEl?.focus();
    }

    // persistent login (no password on refresh)
    if(localStorage.getItem(SESSION_KEY)==="yes"){ showApp(); }
    $("#loginBtn").onclick=()=>{
      const user=$("#u").value.trim(), pass=$("#p").value;
      if(user===LOGIN_USER && pass===LOGIN_PASS){
        localStorage.setItem(SESSION_KEY,"yes");
        showApp();
      } else {
        $("#err").textContent="Invalid credentials.";
      }
    };
    logoutBtn.onclick=()=>{ localStorage.removeItem(SESSION_KEY); location.reload(); };

    /* ---------- Local storage ---------- */
    const getAllLocal = () => { try{return JSON.parse(localStorage.getItem(LKEY)||"[]")}catch{return[]} };
    const setAllLocal = a => localStorage.setItem(LKEY, JSON.stringify(a));

    /* ---------- ORDERING (stable positions) ---------- */
    function normalizePositions(arr){
      arr.sort((a,b)=>(a.pos??0)-(b.pos??0));
      return arr.map((m,i)=>({...m,pos:i}));
    }
    function nextPos(){ return data.length ? Math.max(...data.map(x=>x.pos??0))+1 : 0; }

    /* ---------- Seed (local only) ---------- */
    function starterMacros(now=Date.now()){
      try{
        const arr=JSON.parse(document.getElementById("initial-macros").textContent||"[]");
        return arr.map((m,i)=>({id:rid(),pos:i,updatedAt:now,...m}));
      }catch{ return []; }
    }
    function seedIfEmpty(){
      const local=getAllLocal(); if(local.length) return;
      const seeds=starterMacros(Date.now()); if(!seeds.length) return;
      setAllLocal(seeds);
      setCategoriesLocal(getCategoriesLocal()); // ensure categories exist
    }

    /* ---------- Migration: ensure pos exists & compact ---------- */
    function migrate(items){
      const arr = Array.isArray(items)?items:[];
      const fixed = arr.map((m,i)=> (m.pos==null?{...m,pos:i}:m));
      return normalizePositions(fixed);
    }

    /* ---------- State ---------- */
    let data=[], current=null;
    let filter={group:"All",sub:null};
    let expanded=new Set(JSON.parse(localStorage.getItem(EXPKEY)||'[]'));
    let dotViewId=null;
    let savedScrollY=0, savedCardId=null;

    function restoreAfterRender(){
      if(savedCardId){
        const el=document.getElementById("card-"+savedCardId);
        if(el){
          const y=el.getBoundingClientRect().top+window.scrollY-100;
          window.scrollTo({top:y,behavior:"auto"});
          el.classList.add("hl"); setTimeout(()=>el.classList.remove("hl"),1200);
        }
        savedCardId=null;
      } else if(savedScrollY){ window.scrollTo({top:savedScrollY,behavior:"auto"}); }
    }

    /* ---------- Paragraph rendering + escape ---------- */
    const esc=s=>(s||"").replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    function toParagraphs(s){
      s=(s||"").replace(/\r\n/g,"\n");
      const safe=esc(s);
      return safe.split(/\n{2,}/).map(b=>`<p>${b.replace(/\n/g,"<br>")}</p>`).join("");
    }

    /* ---------- Sidebar ---------- */
    function buildTree(){
      const tree={};
      for(const g of Object.keys(categories)) tree[g]={count:0,subs:{}};
      for(const m of data){
        const g=m.group||"Other", s=m.sub||"";
        if(!tree[g]) tree[g]={count:0,subs:{}};
        tree[g].count++;
        if(s){ tree[g].subs[s]??=0; tree[g].subs[s]++; }
      }
      return tree;
    }

    function renderSidebar(){
      const tree=buildTree(); const order=Object.keys(categories).sort((a,b)=>a.localeCompare(b)); const allCount=data.length;
      let html=`<div class="cat ${filter.group==='All'?'active':''}" data-g="All" aria-expanded="true"><span class="groupHead"><span class="caret">▾</span> All</span><span class="badge">${allCount}</span></div>`;
      for(const g of order){
        const isOpen=expanded.has(g), caret=isOpen?"▾":"▸", col=colorForGroup(g), count=tree[g]?.count||0;
        html+=`<div class="cat ${filter.group===g&&!filter.sub?'active':''}" data-g="${g}" data-color style="--cat-color:${col}" aria-expanded="${isOpen}">
          <span class="groupHead"><span class="caret">${caret}</span> ${esc(g)}</span><span class="badge">${count}</span></div>`;
        const subs=Object.keys(tree[g]?.subs||{}).sort((a,b)=>a.localeCompare(b));
        const cls=`subs ${isOpen?'open':'closed'}`; html+=`<div class="${cls}" data-parent="${g}">`;
        if(subs.length===0){
          html+=`<div class="sub" data-g="${g}" data-s="" data-color style="--cat-color:${col};opacity:.65;pointer-events:none"><span>(no subgroups yet)</span><span class="badge">0</span></div>`;
        } else {
          for(const s of subs){
            const active=filter.group===g && filter.sub===s ? "active":"";
            html+=`<div class="sub ${active}" data-g="${g}" data-s="${esc(s)}" data-color style="--cat-color:${col}"><span>${esc(s)}</span><span class="badge">${tree[g].subs[s]}</span></div>`;
          }
        }
        html+=`</div>`;
      }
      catsEl.innerHTML=html;

      catsEl.querySelectorAll(".cat").forEach(el=>{
        el.onclick=()=>{
          const g=el.dataset.g; dotViewId=null;
          if(g==="All"){ filter={group:"All",sub:null}; renderList(); renderSidebar(); return; }
          if(expanded.has(g)) expanded.delete(g); else expanded.add(g);
          localStorage.setItem(EXPKEY,JSON.stringify([...expanded]));
          filter={group:g,sub:null}; renderList(); renderSidebar(); restoreAfterRender();
        };
      });
      catsEl.querySelectorAll(".sub").forEach(el=>{
        if(el.dataset.s==="") return;
        el.onclick=()=>{ dotViewId=null; filter={group:el.dataset.g, sub:el.dataset.s}; renderList(); renderSidebar(); restoreAfterRender(); };
      });
    }

    /* ---------- Cards ---------- */
    function renderList(){
      const sorted = [...data].sort((a,b)=>(a.pos??0)-(b.pos??0));
      let items=[];
      if(dotViewId){
        const hit=sorted.find(x=>x.id===dotViewId);
        if(hit) items=[hit];
      } else {
        const q=(searchEl.value||"").trim().toLowerCase();
        const byFilter = m => (filter.group==="All" || m.group===filter.group) && (filter.sub? m.sub===filter.sub : true);
        items = sorted.filter(m => byFilter(m) && (!q || (!q.startsWith('.') && (m.title+m.alias+m.group+m.sub+m.body).toLowerCase().includes(q))));
      }
      listEl.innerHTML = items.map(m=>{
        const col=colorForGroup(m.group);
        return `<article class="card" id="card-${m.id}" data-color style="--cat-color:${col}">
          <div class="card-head"></div>
          <div class="card-body">
            <div class="row" style="justify-content:space-between;align-items:flex-start">
              <div>
                <h3 class="title">${esc(m.title)}</h3>
                <div class="small"><span class="alias">.${esc(m.alias)}</span> · ${esc(m.group)} / ${esc(m.sub||'')}</div>
              </div>
              <div class="row">
                <button class="btn primary" data-action="copy" data-id="${m.id}" aria-label="Copy macro" type="button">Copy</button>
                <button class="btn" data-action="edit" data-id="${m.id}" aria-label="Edit macro" type="button">Edit</button>
              </div>
            </div>
            <div class="macro-body" data-id="${m.id}">${toParagraphs(m.body||"")}</div>
          </div>
        </article>`;
      }).join("");

      listEl.querySelectorAll("[data-action='copy']").forEach(b=>b.onclick=()=>copy(b.dataset.id));
      listEl.querySelectorAll("[data-action='edit']").forEach(b=>b.onclick=()=>openEditor(b.dataset.id));

      if(!dotViewId) highlight(normalQuery());
      if(dotViewId){
        const el=document.getElementById("card-"+dotViewId);
        el?.scrollIntoView({behavior:"smooth",block:"end"});
        el?.classList.add("hl"); setTimeout(()=>el?.classList.remove("hl"),1200);
      }
    }

    async function copy(id){
      const m=data.find(x=>x.id===id);
      try{ await navigator.clipboard.writeText(m.body||""); }
      catch{
        const ta=document.createElement("textarea");
        ta.value=m.body||""; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
      }
      toast("Copied");
    }

    /* ---------- Editor ---------- */
    let lastActiveEl = null;

    function populateGroupOptions(){
      const gSel=$("#fGroup");
      const cats=Object.keys(categories).sort((a,b)=>a.localeCompare(b));
      gSel.innerHTML=cats.map(g=>`<option value="${g}">${g}</option>`).join("");
    }
    function populateSubSuggestions(group){
      const d=$("#subOptions");
      const subs=[...new Set(data.filter(x=>x.group===group).map(x=>x.sub).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      d.innerHTML=subs.map(s=>`<option value="${esc(s)}">`).join("");
    }
    function updateAliasPrefix(){ $("#aliasPrefix").textContent = "."+prefixForGroup($("#fGroup").value); }

    function openEditor(id, defaults){
      lastActiveEl = document.activeElement;

      const blank={
        id:null,
        group:defaults?.group || (filter.group && filter.group!=="All"?filter.group:(Object.keys(categories)[0]||"Pediatrics")),
        sub:defaults?.sub||filter.sub||"",
        title:"", alias:"", body:""
      };
      current = data.find(x=>x.id===id) || blank;

      $("#edTitle").textContent=current.id?"Edit Macro":"New Macro";
      populateGroupOptions(); $("#fGroup").value=current.group||Object.keys(categories)[0];
      populateSubSuggestions($("#fGroup").value); $("#fSub").value=current.sub||"";
      updateAliasPrefix();

      const pref=prefixForGroup($("#fGroup").value);
      const suffix=(current.alias||"").toLowerCase().startsWith(pref)?(current.alias||"").slice(pref.length):"";
      $("#fAliasSuffix").value=suffix;
      $("#fTitle").value=current.title||"";
      $("#fBody").value=current.body||"";

      $("#fGroup").onchange=()=>{ populateSubSuggestions($("#fGroup").value); updateAliasPrefix(); };

      savedScrollY=window.scrollY; savedCardId=current.id||null;
      editorDlg.showModal();
    }

    // Editor shortcuts
    document.addEventListener("keydown",(e)=>{
      if(!editorDlg.open) return;
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); $("#saveBtn").click(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="d"){ e.preventDefault(); $("#dupBtn").click(); }
      if(e.key==="Escape"){ e.preventDefault(); $("#closeEd").click(); }
    });

    $("#closeEd").onclick=()=>{ editorDlg.close(); if(lastActiveEl) lastActiveEl.focus(); restoreAfterRender(); };

    $("#saveBtn").onclick=async ()=>{
      const group=$("#fGroup").value.trim(), sub=$("#fSub").value.trim(), title=$("#fTitle").value.trim();
      const suffix=($("#fAliasSuffix").value||"").trim().toLowerCase().replace(/\s+/g,'');
      const alias=prefixForGroup(group)+suffix, body=$("#fBody").value;
      if(!group||!title||!suffix){ toast("Group, Title & alias suffix required"); return; }

      const taken = data.some(x=>x.id!==current.id && (x.alias||"").toLowerCase()===alias.toLowerCase());
      if(taken){ toast("Alias already exists"); return; }

      const m = current.id ? {...current} : {id:rid(), pos: nextPos()};
      Object.assign(m,{group,sub,title,alias,body}); // keep pos intact

      upsert(m);
      editorDlg.close(); if(lastActiveEl) lastActiveEl.focus();
      renderSidebar(); renderList(); toast("Saved"); restoreAfterRender();
    };

    $("#delBtn").onclick=async ()=>{
      if(!current.id){editorDlg.close();return;}
      if(confirm("Delete this macro?")){
        data=data.filter(x=>x.id!==current.id);
        data = normalizePositions(data);
        setAllLocal(data);
        editorDlg.close(); if(lastActiveEl) lastActiveEl.focus();
        renderSidebar(); renderList(); toast("Deleted"); restoreAfterRender();
      }
    };

    $("#dupBtn").onclick=async ()=>{
      const base = current || {};
      const m={...base,id:rid(),title:(base.title||"Untitled")+" (copy)"};
      m.pos = (base.pos!=null ? base.pos+0.5 : nextPos());
      const suffix = ($("#fAliasSuffix").value||"copy").replace(/\s+/g,'').toLowerCase();
      const group = $("#fGroup").value || base.group || "Other";
      m.alias = prefixForGroup(group)+suffix;
      upsert(m); renderSidebar(); renderList(); toast("Duplicated"); restoreAfterRender();
    };

    function upsert(m){
      const i=data.findIndex(x=>x.id===m.id);
      if(i>=0) data[i]=m; else data.push(m);
      data.forEach((x,i2)=>{ if(typeof x.pos!=="number" || Number.isNaN(x.pos)) x.pos=i2; });
      data = normalizePositions(data);
      setAllLocal(data);
    }

    /* ---------- Search / nav ---------- */
    let hits=[],hitIdx=-1;
    const normalQuery=()=>{const q=(searchEl.value||"").trim();return q.startsWith(".")?"":q.toLowerCase();}
    function updateCounter(){ if(!hits.length){ hitCount.textContent=""; return; } hitCount.textContent=`${hitIdx>=0?hitIdx+1:0}/${hits.length}`; }

    function highlight(q){
      document.querySelectorAll(".card .macro-body").forEach(el=>{
        const id=el.getAttribute("data-id"); const m=data.find(x=>x.id===id);
        el.innerHTML=toParagraphs(m?.body||"");
      });
      if(!q){ hits=[]; hitIdx=-1; updateCounter(); return; }

      const safe=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); 
      const regex=new RegExp(safe,"gi");
      const hitIds = new Set();

      document.querySelectorAll(".card .macro-body").forEach(el=>{
        el.innerHTML = el.innerHTML.replace(regex, m => `<mark>${m}</mark>`);
        const cardId = el.closest(".card")?.id?.replace("card-","");
        if(el.querySelector("mark") && cardId) hitIds.add(cardId);
      });

      hits = [...hitIds]; // de-duped per card
      hitIdx = -1; 
      updateCounter();
    }

    function gotoNext(){ if(!hits.length)return; hitIdx=(hitIdx+1)%hits.length; const el=document.getElementById("card-"+hits[hitIdx]); el?.scrollIntoView({behavior:"smooth",block:"center"}); el?.classList.add("hl"); setTimeout(()=>el?.classList.remove("hl"),1200); updateCounter(); }
    function gotoPrev(){ if(!hits.length)return; hitIdx=(hitIdx<=0?hits.length-1:hitIdx-1); const el=document.getElementById("card-"+hits[hitIdx]); el?.scrollIntoView({behavior:"smooth",block:"center"}); el?.classList.add("hl"); setTimeout(()=>el?.classList.remove("hl"),1200); updateCounter(); }
    prevBtn.onclick=gotoPrev; nextBtn.onclick=gotoNext;

    newBtn.onclick=()=>{ if(settingsDlg.open) settingsDlg.close(); const defaults={group:(filter.group&&filter.group!=="All")?filter.group:undefined, sub:filter.sub||undefined}; openEditor(null,defaults); };
    searchEl.oninput=()=>{ if(!searchEl.value.startsWith(".")){ dotViewId=null; } renderList(); };
    searchEl.onkeydown=e=>{
      if(e.key==="Enter"){
        const raw=searchEl.value.trim();
        if(raw.startsWith(".")){
          const q=raw.slice(1).toLowerCase();
          const exact=data.find(m=>(m.alias||"").toLowerCase()===q);
          if(exact){
            try{ navigator.clipboard.writeText(exact.body||""); }catch{}
            toast("Copied");
            dotViewId=exact.id;
            filter={group:exact.group, sub:exact.sub||null};
            renderSidebar(); renderList(); restoreAfterRender();
            return;
          } else toast("No alias match");
        } else { e.shiftKey?gotoPrev():gotoNext(); }
      } else if(e.key==="Escape"){ searchEl.value=""; dotViewId=null; renderList(); restoreAfterRender(); }
    };

    /* ---------- Settings ---------- */
    settingsBtn.onclick=()=>{ lastActiveEl = document.activeElement; renderSettings(); settingsDlg.showModal(); };
    $("#closeSettings").onclick=()=>{ settingsDlg.close(); if(lastActiveEl) lastActiveEl.focus(); renderSidebar(); renderList(); restoreAfterRender(); };
    $("#addCatBtn").onclick=()=>{
      const cats=categories;
      let base="New Category",name=base,i=1;
      while(cats[name]) name=`${base} ${i++}`;
      cats[name]={color:"#0FA6A6",prefix:"new"};
      setCategoriesLocal(cats); categories=cats;
      expanded.add(name); localStorage.setItem(EXPKEY,JSON.stringify([...expanded]));
      filter={group:name,sub:null};
      settingsDlg.close(); renderSidebar(); openEditor(null,{group:name});
    };

    function renderSettings(){
      const container=$("#catRows"); container.innerHTML="";
      Object.entries(categories).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([name,info])=> addCatRow({name,prefix:info.prefix,color:info.color}));
    }

    function addCatRow({name,prefix,color},focus=false){
      const row=document.createElement("div"); row.className="settings-grid";
      row.innerHTML=`<input class="input catName" value="${esc(name)}" aria-label="Category name">
        <input class="input catPre" value="${esc(prefix)}" aria-label="Prefix">
        <input class="input catCol" type="color" value="${toHex(color)}" aria-label="Color">
        <div class="row" style="justify-content:flex-end"><button class="btn danger delBtn" type="button">Delete</button></div>`;
      $("#catRows").appendChild(row);
      const nameEl=row.querySelector(".catName"), preEl=row.querySelector(".catPre"), colEl=row.querySelector(".catCol"), delBtn=row.querySelector(".delBtn"); if(focus) nameEl.select();

      const commit=()=>{
        const oldName=name,
              newName=(nameEl.value||"").trim()||oldName,
              newPrefix=(preEl.value||"").trim().toLowerCase().replace(/\s+/g,'')||"other",
              newColor=colEl.value||"#9ab7e6";

        if(newName!==oldName){
          // preserve expansion on rename
          const EXPKEY="rvsred-expanded";
          let expandedSet=new Set(JSON.parse(localStorage.getItem(EXPKEY)||'[]'));
          const wasOpen = expandedSet.has(oldName);
          if(wasOpen){ expandedSet.delete(oldName); expandedSet.add(newName); }
          localStorage.setItem(EXPKEY, JSON.stringify([...expandedSet]));

          categories[newName]={color:newColor,prefix:newPrefix};
          delete categories[oldName];
          data=getAllLocal().map(m=> m.group===oldName?{...m,group:newName}:m);
          data=normalizePositions(data); setAllLocal(data);
          name=newName;
        } else {
          categories[newName]={color:newColor,prefix:newPrefix};
        }
        setCategoriesLocal(categories);
        renderSidebar(); renderList(); restoreAfterRender();
      };
      ["input","change","blur"].forEach(ev=>{
        nameEl.addEventListener(ev,commit);
        preEl.addEventListener(ev,commit);
        colEl.addEventListener(ev,commit);
      });
      delBtn.onclick=()=>{
        if(!confirm(`Delete category "${name}"? Macros will move to "Other".`)) return;
        delete categories[name];
        setCategoriesLocal(categories);
        data=getAllLocal().map(m=> m.group===name?{...m,group:"Other"}:m);
        data=normalizePositions(data); setAllLocal(data);
        row.remove(); renderSidebar(); renderList(); restoreAfterRender();
      };
    }

    function toHex(c){ const ctx=document.createElement("canvas").getContext("2d"); ctx.fillStyle=c; const v=ctx.fillStyle; return v.startsWith("#")?v:"#9ab7e6"; }

    // Backup export (local JSON file)
    if(backupBtn){
      backupBtn.onclick=()=>{
        const blob=new Blob([JSON.stringify({macros:getAllLocal(),categories:getCategoriesLocal()},null,2)],{type:"application/json"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
        const d=new Date(); const ts=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
        a.download=`rvsred-backup-${ts}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
      };
    }

    /* ---------- Boot ---------- */
    function boot(){
      seedIfEmpty();
      data=migrate(getAllLocal());
      categories=getCategoriesLocal();
      renderSidebar(); renderList();
    }

    /* ---------- Login Enter key ---------- */
    document.addEventListener("DOMContentLoaded",()=>{
      const user=$("#u"), pass=$("#p"), btn=$("#loginBtn");
      [user,pass].forEach(el=>el?.addEventListener("keydown",e=>{ if(e.key==="Enter"){ e.preventDefault(); btn?.click(); } }));
      user?.focus();
    });
  })();
  </script>
</body>
</html>
