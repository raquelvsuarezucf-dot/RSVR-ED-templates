<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>RVSRED Templates — Local</title>

<meta name="description" content="Emergency Medicine documentation templates — No PHI stored.">

<style>

  :root{

    --bg:#eaf1fb; --bg2:#dbe7f6; --panel:#fff; --border:#cfe0f5;

    --primary:#1E70C1; --primary2:#3A8BE0; --text:#0f2640; --muted:#5b6b84;

    --radius:16px; --shadow:0 8px 28px rgba(15,38,64,.08);

  }

  *{box-sizing:border-box}

  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font:17px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .hidden{display:none!important}

  .wrap{max-width:1200px;margin:0 auto;padding:16px}

  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#e6effd);border-bottom:1px solid var(--border)}

  .toolbar{display:flex;gap:14px;align-items:center;justify-content:space-between}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .input,textarea,.btn,select{font:inherit}

  .input,textarea,select{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;color:#0f2640}

  .btn{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer}

  .btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary2));color:#fff;border-color:transparent;font-weight:700}

  .layout{display:grid;grid-template-columns:280px 1fr;gap:16px}

  /* --- Search field emphasis --- */

  #search{

    flex:1; min-width:260px;

    font-size:18px;

    padding:14px 16px;

    border:2px solid #a8c4ec;

    box-shadow:0 2px 10px rgba(30,112,193,.12);

    height:48px;

  }

  #search:focus{

    outline:none;

    border-color:#1E70C1;

    box-shadow:0 0 0 4px rgba(30,112,193,.18), 0 6px 22px rgba(30,112,193,.18);

  }

  /* Sidebar (collapsible, color-matched) */

  .sidebar{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}

  .side-title{font-weight:800;margin:2px 0 8px}

  .cat,.sub{

    display:flex;justify-content:space-between;align-items:center;

    border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:6px 0;

    background:#fbfdff;cursor:pointer;user-select:none; transition:background .15s ease, border-color .15s ease;

  }

  .cat[data-color]{border-color:color-mix(in srgb, var(--cat-color, #cfe0f5), #000 8%);

                   background:color-mix(in srgb, var(--cat-color, #cfe0f5), #fff 86%);}

  .sub[data-color]{border-color:color-mix(in srgb, var(--cat-color, #cfe0f5), #000 8%);

                   background:color-mix(in srgb, var(--cat-color, #cfe0f5), #fff 92%);}

  .cat.active,.sub.active{outline:3px solid #8AC0FF;background:#f0f7ff}

  .groupHead{display:flex;align-items:center;gap:10px}

  .caret{font-size:14px;opacity:.8;transition:transform .2s ease}

  .subs{margin-left:10px;overflow:hidden;transition:max-height .22s ease}

  .subs.closed{max-height:0}

  .subs.open{max-height:1000px}

  .badge{font-size:12px;background:#eaf2ff;border:1px solid var(--border);border-radius:999px;padding:2px 8px}

  /* Cards */

  .list{display:grid;gap:16px}

  .card{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}

  .card-head{height:64px}

  .card[data-color] .card-head{

    background:linear-gradient(180deg,

     color-mix(in srgb, var(--cat-color, #9ab7e6), #fff 70%), var(--cat-color, #9ab7e6));

  }

  .card-body{padding:16px}

  .title{font-weight:800;margin:0 0 6px}

  .small{font-size:14px;color:#5b6b84}

  .alias{color:var(--primary);font-weight:800}

  pre{white-space:pre-wrap;font-size:16px;color:#1d3657;background:#fafcff;border:1px dashed #e1ecfb;border-radius:12px;padding:12px;max-height:240px;overflow:auto;margin:8px 0 0}

  mark{background:#fff3a1;padding:0 .12em;border-radius:4px}

  .hl{outline:3px solid #8AC0FF;transition:outline-color .6s ease}

  /* Login */

  .center{display:grid;place-items:center;min-height:100dvh;padding:24px}

  .login{background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px;width:min(620px,96vw)}

  .muted{color:#5b6b84}

  /* Dialogs */

  dialog{border:none;border-radius:16px;padding:0;max-width:min(860px,96vw)}

  dialog .content{padding:16px}

  .actions{display:flex;gap:10px;justify-content:flex-end}

  .aliasRow{display:flex;align-items:center;gap:8px}

  .prefix{background:#f3f6ff;border:1px solid #d9e6ff;padding:10px 12px;border-radius:12px;color:#1b3a66}

  /* Settings modal */

  .settings-grid{display:grid;grid-template-columns:1fr 140px 120px 110px;gap:8px;align-items:center}

  .settings-grid .hdr{font-weight:700;font-size:14px;color:#2a3b55}

  .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#f7faff}

  .danger{background:#ffe9e8;border-color:#ffc8c4;color:#7f1d1d}

  .soft{opacity:.8}

</style>

</head>

<body>

  <!-- Login -->

  <div id="login" class="center">

    <div class="login">

      <h1 style="margin:0 0 8px">RVSRED Templates — Authorized Access Only</h1>

      <p class="muted" style="margin:0 0 12px">Emergency Medicine Documentation Utility — No PHI stored.</p>

      <label class="small">Username</label>

      <input id="u" class="input" autocomplete="off" />

      <div style="height:8px"></div>

      <label class="small">Password</label>

      <input id="p" type="password" class="input" />

      <div style="height:12px"></div>

      <button id="loginBtn" class="btn primary" style="width:100%">Sign in</button>

      <p id="err" class="small" style="color:#b3261e;margin-top:10px"></p>

    </div>

  </div>

  <!-- App -->

  <div id="app" class="hidden">

    <header>

      <div class="wrap toolbar">

        <div class="row" style="flex:1">

          <input id="search" class="input" type="search" aria-label="Search templates"

                 placeholder="Search…  (Enter = Next • Shift+Enter = Prev • .alias to copy)" />

          <button id="prevBtn" class="btn" title="Previous result">Prev</button>

          <button id="nextBtn" class="btn" title="Next result">Next</button>

          <span id="hitCount" class="small" style="min-width:80px;text-align:center;color:#2a3b55"></span>

        </div>

        <div class="row">

          <button id="newBtn" class="btn">New</button>

          <button id="settingsBtn" class="btn" title="Manage categories">⚙️ Settings</button>

        </div>

      </div>

    </header>

    <div class="wrap layout">

      <!-- Sidebar -->

      <aside class="sidebar">

        <div class="side-title">Categories</div>

        <div id="cats"></div>

      </aside>

      <!-- Content -->

      <main>

        <div id="list" class="list"></div>

      </main>

    </div>

  </div>

  <!-- Toast -->

  <div id="toast" class="hidden" role="status" aria-live="polite" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f2640;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2)">Copied</div>

  <!-- Editor -->

  <dialog id="editor">

    <div class="content">

      <h3 id="edTitle">Edit Macro</h3>

      <div class="row">

        <div style="flex:1">

          <label class="small">Category (Group) *</label>

          <select id="fGroup" class="input"></select>

        </div>

        <div style="flex:1">

          <label class="small">Subgroup *</label>

          <input id="fSub" class="input" list="subOptions" placeholder="e.g., URI, Asthma, Sign-Out" />

          <datalist id="subOptions"></datalist>

        </div>

      </div>

      <div style="height:6px"></div>

      <label class="small">Title *</label>

      <input id="fTitle" class="input" />

      <div style="height:6px"></div>

      <label class="small">Alias (dot-phrase uses this)</label>

      <div class="aliasRow">

        <span id="aliasPrefix" class="prefix">.peds</span>

        <input id="fAliasSuffix" class="input" placeholder="e.g., viral  → .pedsviral" />

      </div>

      <div style="height:6px"></div>

      <label class="small">Body</label>

      <textarea id="fBody" rows="12" class="input" style="height:260px"></textarea>

      <div class="actions">

        <button id="dupBtn" class="btn">Duplicate</button>

        <button id="delBtn" class="btn danger">Delete</button>

        <button id="saveBtn" class="btn primary">Save</button>

        <button id="closeEd" class="btn">Close</button>

      </div>

    </div>

  </dialog>

  <!-- Settings / Category Manager -->

  <dialog id="settings">

    <div class="content">

      <h3 style="margin:0 0 10px">Manage Categories</h3>

      <div class="settings-grid soft">

        <div class="hdr">Category</div>

        <div class="hdr">Prefix</div>

        <div class="hdr">Color</div>

        <div class="hdr">Actions</div>

      </div>

      <div id="catRows" style="display:grid;gap:8px;margin:8px 0 12px"></div>

      <div class="row" style="justify-content:space-between">

        <button id="addCatBtn" class="btn">+ Add Category</button>

        <div class="row">

          <span class="pill">Changes save instantly</span>

          <button id="closeSettings" class="btn">Close</button>

        </div>

      </div>

    </div>

  </dialog>

<script>

(() => {

  const $ = s => document.querySelector(s);

  const listEl = $("#list"),

        searchEl = $("#search"),

        catsEl = $("#cats"),

        toastEl = $("#toast"),

        settingsDlg = $("#settings"),

        editorDlg = $("#editor"),

        prevBtn = $("#prevBtn"),

        nextBtn = $("#nextBtn"),

        newBtn = $("#newBtn"),

        hitCount = $("#hitCount");

  const LKEY="rvsred-macros", EXPKEY="rvsred-expanded", CKEY="rvsred-categories";

  const LOGIN_USER="EDtemplates", LOGIN_PASS="odynophagia";

  const rid=()=>crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2);

  const toast = t => { toastEl.textContent=t; toastEl.classList.remove("hidden"); setTimeout(()=>toastEl.classList.add("hidden"),1600); };

  /* ---------- Categories ---------- */

  function defaultCategories(){

    return {"Pediatrics":{color:"#1E70C1",prefix:"peds"},"ED Communication":{color:"#6C5CE7",prefix:"edc"},"Other":{color:"#9ab7e6",prefix:"other"}};

  }

  function getCategories(){ try{ return JSON.parse(localStorage.getItem(CKEY)) || defaultCategories(); } catch{ return defaultCategories(); } }

  function setCategories(map){ localStorage.setItem(CKEY, JSON.stringify(map)); }

  function ensureCategory(g){

    const cats=getCategories();

    if(!cats[g]){

      cats[g]={color:"#9ab7e6", prefix:(g||"other").toLowerCase().replace(/\s+/g,'')||"other"};

      setCategories(cats);

    }

  }

  let categories = getCategories();

  const colorForGroup = g => (categories[g]?.color)||"#9ab7e6";

  const prefixForGroup = g => (categories[g]?.prefix)||"other";

  /* ---------- Login ---------- */

  $("#loginBtn").onclick=()=>{ if($("#u").value.trim()===LOGIN_USER&&$("#p").value===LOGIN_PASS){ $("#login").classList.add("hidden"); $("#app").classList.remove("hidden"); load(); searchEl.focus(); } else $("#err").textContent="Invalid credentials."; };

  /* ---------- Storage ---------- */

  const getAll = () => { try{return JSON.parse(localStorage.getItem(LKEY)||"[]")}catch{return[]} };

  const setAll = a => localStorage.setItem(LKEY, JSON.stringify(a));

  /* ---------- Seed data ---------- */

  function seedIfEmpty(){

    if(getAll().length) return;

    const now=Date.now();

    setAll([

      {id:rid(),group:"Pediatrics",sub:"URI",title:"MDM — Pediatric Viral / Febrile Illness",alias:"pedsviral",body:`[age]-year-old [sex] presented to the ED with [duration] of fever and associated [symptoms: cough, nasal congestion, rhinorrhea, decreased appetite, irritability]. Parent present at bedside reports patient has been tolerating PO without difficulties, with [no / mild] decrease in appetite and normal urine output. Denies vomiting, diarrhea, rash, or respiratory distress. Immunizations are up to date.

On evaluation, patient appeared well hydrated, interactive, and appropriate for age, with normal capillary refill and no increased work of breathing. Oropharynx clear, tympanic membranes without bulging or erythema, lungs clear to auscultation, and abdomen soft, non-tender, and non-distended.

Differential includes viral upper respiratory infection, early otitis media, influenza, RSV, COVID-19, and early pneumonia, though there were no focal findings to strongly suggest a bacterial source. Findings today are most consistent with a viral process. [COVID, influenza, and RSV tests were negative / pending / positive for ___ / not obtained.]

Patient remained comfortable and interactive throughout the ED visit with stable vital signs and reassuring physical findings. Findings reviewed with the parent at bedside, and supportive care discussed, including weight-based acetaminophen or ibuprofen for fever and encouraging fluids as tolerated. Parent verbalized understanding and was comfortable with the plan for discharge and outpatient follow-up.

Strict return precautions discussed, including persistent fever, respiratory distress, poor oral intake, vomiting, decreased urine output, new rash, or any new or concerning symptoms. Follow-up with pediatrician advised within 48–72 hours or sooner if symptoms worsen.`,updatedAt:now},

      {id:rid(),group:"Pediatrics",sub:"URI",title:"MDM — Pediatric Streptococcal Pharyngitis",alias:"pedspharyn",body:`[age]-year-old [sex] presented to the ED with [duration] of sore throat associated with [symptoms: fever, decreased appetite, odynophagia, mild cough / no cough, nasal congestion]. Parent present at bedside reports patient has been tolerating PO intake [well / poorly] and maintaining normal urine output. Denies vomiting, drooling, neck stiffness, or respiratory distress. Immunizations are up to date.

On exam, patient appeared well hydrated, interactive, and nontoxic. Oropharyngeal exam notable for [tonsillar erythema / exudates / palatal petechiae / none], uvula midline, and no evidence of peritonsillar swelling or trismus. Cervical nodes [tender / non-tender, enlarged / not enlarged]. Lungs clear to auscultation and no meningeal signs or rash observed.

Differential includes streptococcal pharyngitis, viral pharyngitis, early tonsillitis, and mononucleosis, with low concern for peritonsillar abscess, epiglottitis, or retropharyngeal infection given the reassuring airway exam and overall well appearance. Findings today are most consistent with [streptococcal / viral] pharyngitis. [Rapid strep test positive / negative / pending; throat culture sent / not obtained.] [COVID, influenza, and RSV tests negative / positive for ___ / not obtained.]

For confirmed or suspected streptococcal infection, prescribed [amoxicillin / cephalexin / azithromycin] — weight-based dosing — with instructions to complete the full course. Supportive care discussed, including acetaminophen or ibuprofen for fever or throat pain, maintaining hydration, and soft foods as tolerated.

Patient remained comfortable and interactive throughout the ED visit with stable vital signs and reassuring physical findings. Findings reviewed with the parent at bedside, who verbalized understanding and was comfortable with the plan for discharge and outpatient follow-up.

Strict return precautions discussed, including persistent fever, worsening throat pain, drooling, difficulty swallowing or breathing, neck swelling, or any new or concerning symptoms. Follow-up with pediatrician advised within 48–72 hours or sooner if symptoms worsen.`,updatedAt:now},

      {id:rid(),group:"Pediatrics",sub:"URI",title:"MDM — Pediatric Otitis Media",alias:"pedsom",body:`[age]-year-old [sex] presented to the ED with [duration] of ear pain associated with [symptoms: fever, nasal congestion, cough, irritability, decreased appetite]. Parent present at bedside reports patient has been tolerating PO intake [well / poorly] with normal urinary output. Denies vomiting, drainage from the ear, rash, or respiratory distress. Immunizations are up to date.

On exam, patient appeared well hydrated and interactive for age. Right / left tympanic membrane noted to be [erythematous / bulging / dull / effusion present / normal]; no mastoid tenderness, auricular swelling, or drainage. Contralateral ear within normal limits. Lungs clear to auscultation, and oropharynx without erythema or exudate. Neck supple with full range of motion and no lymphadenopathy. Abdomen soft and non-tender.

Differential includes acute otitis media, otitis externa, eustachian tube dysfunction, and viral upper respiratory infection. Findings today are most consistent with [acute otitis media / serous otitis / viral URI with referred ear pain]. [COVID, influenza, and RSV tests negative / positive for ___ / not obtained.]

If bacterial: Antibiotic therapy initiated with [amoxicillin / cefdinir / azithromycin], weight-based, and first dose given in the ED. Supportive care discussed with parent, including acetaminophen or ibuprofen for pain or fever, and maintaining hydration. If symptoms fail to improve or worsen despite treatment, advised prompt re-evaluation.

If non-bacterial / watchful waiting: Findings reviewed with parent at bedside. Presentation may represent early or serous otitis rather than acute bacterial infection; advised supportive care with acetaminophen or ibuprofen as needed and close follow-up if symptoms persist or worsen.

Patient remained comfortable and interactive throughout the ED visit with stable vital signs and reassuring physical findings. Findings and plan reviewed with parent at bedside, who verbalized understanding and was comfortable with discharge and outpatient follow-up.

Strict return precautions discussed, including persistent fever, worsening ear pain, drainage from the ear, vomiting, lethargy, poor oral intake, new rash, neck stiffness, or any new or concerning symptoms. Follow-up with pediatrician advised within 48–72 hours or sooner if symptoms worsen.`,updatedAt:now},

      {id:rid(),group:"Pediatrics",sub:"URI",title:"MDM — Pediatric Pneumonia",alias:"pedspna",body:`Patient presented with [cough / fever / shortness of breath / malaise] for [duration] prior to arrival. Parent present at bedside reports [persistent cough / decreased appetite / mild fatigue / increased work of breathing] with [no vomiting / no lethargy / no rash]. On exam, patient was alert, interactive, and behaving appropriately for age. Lungs revealed [focal crackles / diminished breath sounds / rhonchi / mild wheezing], with [no retractions / no nasal flaring / normal oxygen saturation]. Findings otherwise reassuring, with no signs of respiratory distress or dehydration.

Differential includes viral pneumonia, bacterial pneumonia, bronchiolitis, asthma or reactive airway exacerbation, and upper respiratory infection. Findings today are most consistent with [bacterial / viral] pneumonia based on clinical picture and [chest x-ray results / auscultatory findings].

Findings and imaging were consistent with [bacterial / viral] pneumonia. Patient was [prescribed / given] [amoxicillin / azithromycin / cefdinir], weight-based, for outpatient treatment. Supportive care discussed with parent at bedside, including acetaminophen or ibuprofen for fever control and encouraging fluids as tolerated. [Continued with prescribed albuterol as needed.] Parent verbalized understanding and was comfortable with the plan for discharge and follow-up.

Return precautions discussed, including but not limited to: worsening or persistent fever, increased work of breathing, chest pain, vomiting, lethargy, poor oral intake, cyanosis, or any new or concerning symptoms. Advised follow-up with pediatrician within 48–72 hours for reassessment or sooner if symptoms worsen.`,updatedAt:now},

      {id:rid(),group:"ED Communication",sub:"Sign-Out",title:"Sign-Out — Giving",alias:"signoutgive",body:`Patient signed out to [Dr. _____] at [time] with pending [labs / imaging / re-evaluation]. Clinical course and current status reviewed in detail. Disposition options discussed and plan of care conveyed to the receiving provider, who will follow pending results and determine final disposition. Patient remained stable at time of sign-out.`,updatedAt:now},

      {id:rid(),group:"ED Communication",sub:"Sign-Out",title:"Sign-Out — Receiving",alias:"signoutrecv",body:`Patient received in sign-out from [Dr. _____] at [time] with pending [results / re-evaluation / consults]. Prior ED course, findings, and disposition considerations reviewed. Assuming ongoing care and final disposition.`,updatedAt:now}

    ]);

  }

  /* ---------- Migration (aliases) ---------- */

  function migrate(items){

    const mapOldToNew = { viralpeds:"pedsviral", pedstrep:"pedspharyn", pedsphay:"pedspharyn" };

    let changed=false;

    for(const m of items){ if(mapOldToNew[m.alias]){ m.alias=mapOldToNew[m.alias]; changed=true; } }

    if(changed) setAll(items);

    return items;

  }

  /* ---------- State ---------- */

  let data=[], current=null;

  let filter = {group:"All", sub:null};

  let expanded = new Set(JSON.parse(localStorage.getItem(EXPKEY)||'[]'));

  /* ---------- Sidebar ---------- */

  function buildTree(){

    const tree = {};

    for(const m of data){

      const g=m.group||"Other", s=m.sub||"";

      tree[g] ??= {count:0, subs:{}};

      tree[g].count++;

      if(s){ tree[g].subs[s] ??= 0; tree[g].subs[s]++; }

    }

    return tree;

  }

  function renderSidebar(){

    const tree = buildTree();

    const order = Object.keys(tree).sort((a,b)=>a.localeCompare(b));

    const allCount = data.length;

    let html = `<div class="cat ${filter.group==='All'?'active':''}" data-g="All"><span class="groupHead"><span class="caret">▾</span> All</span><span class="badge">${allCount}</span></div>`;

    for(const g of order){

      ensureCategory(g);

      const isOpen = expanded.has(g);

      const caret = isOpen ? "▾" : "▸";

      const col = colorForGroup(g);

      html += `<div class="cat ${filter.group===g && !filter.sub?'active':''}" data-g="${g}" data-color style="--cat-color:${col}">

        <span class="groupHead"><span class="caret">${caret}</span> ${g}</span>

        <span class="badge">${tree[g].count}</span>

      </div>`;

      const subs = Object.keys(tree[g].subs).sort((a,b)=>a.localeCompare(b));

      const cls = `subs ${isOpen?'open':'closed'}`;

      html += `<div class="${cls}" data-parent="${g}">`;

      for(const s of subs){

        const active = filter.group===g && filter.sub===s ? "active" : "";

        html += `<div class="sub ${active}" data-g="${g}" data-s="${s}" data-color style="--cat-color:${col}">

          <span>${s}</span><span class="badge">${tree[g].subs[s]}</span>

        </div>`;

      }

      html += `</div>`;

    }

    $("#cats").innerHTML = html;

    $("#cats").querySelectorAll(".cat").forEach(el=>{

      el.onclick = ()=>{

        const g = el.dataset.g;

        if(g==="All"){ filter={group:"All", sub:null}; renderList(); renderSidebar(); return; }

        if(expanded.has(g)) expanded.delete(g); else expanded.add(g);

        localStorage.setItem(EXPKEY, JSON.stringify([...expanded]));

        filter={group:g, sub:null};

        renderList(); renderSidebar();

      };

    });

    $("#cats").querySelectorAll(".sub").forEach(el=>{

      el.onclick = ()=>{ filter={group:el.dataset.g, sub:el.dataset.s}; renderList(); renderSidebar(); };

    });

  }

  /* ---------- Cards ---------- */

  const esc=s=>(s||"").replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  function renderList(){

    const q=(searchEl.value||"").trim().toLowerCase();

    const byFilter = m => (filter.group==="All" || m.group===filter.group) && (filter.sub? m.sub===filter.sub : true);

    const items=data.filter(m => byFilter(m) && (!q || (m.title+m.alias+m.group+m.sub+m.body).toLowerCase().includes(q)));

    listEl.innerHTML = items.map(m=>{

      ensureCategory(m.group);

      const col = colorForGroup(m.group);

      return `

      <article class="card" id="card-${m.id}" data-color style="--cat-color:${col}">

        <div class="card-head"></div>

        <div class="card-body">

          <div class="row" style="justify-content:space-between;align-items:flex-start">

            <div>

              <h3 class="title">${esc(m.title)}</h3>

              <div class="small"><span class="alias">.${esc(m.alias)}</span> · ${esc(m.group)} / ${esc(m.sub||'')}</div>

            </div>

            <div class="row">

              <button class="btn primary" data-action="copy" data-id="${m.id}">Copy</button>

              <button class="btn" data-action="edit" data-id="${m.id}">Edit</button>

            </div>

          </div>

          <pre>${esc(m.body||"")}</pre>

        </div>

      </article>`;

    }).join("");

    listEl.querySelectorAll("[data-action='copy']").forEach(b=>b.onclick=()=>copy(b.dataset.id));

    listEl.querySelectorAll("[data-action='edit']").forEach(b=>b.onclick=()=>openEditor(b.dataset.id));

    highlight(normalQuery());

  }

  async function copy(id){ const m=data.find(x=>x.id===id); try{await navigator.clipboard.writeText(m.body||"");}catch{} toast("Copied"); }

  /* ---------- Editor ---------- */

  function populateGroupOptions(){

    const gSel=$("#fGroup"); const cats=Object.keys(categories).sort((a,b)=>a.localeCompare(b));

    gSel.innerHTML = cats.map(g=>`<option value="${g}">${g}</option>`).join("");

  }

  function populateSubSuggestions(group){

    const d=$("#subOptions");

    const subs=[...new Set(data.filter(x=>x.group===group).map(x=>x.sub).filter(Boolean))].sort((a,b)=>a.localeCompare(b));

    d.innerHTML=subs.map(s=>`<option value="${s}">`).join("");

  }

  function updateAliasPrefix(){ $("#aliasPrefix").textContent = "."+prefixForGroup($("#fGroup").value); }

  function openEditor(id, defaults){

    const blank = {

      id: null,

      group: defaults?.group || (filter.group && filter.group !== "All" ? filter.group : "Pediatrics"),

      sub: defaults?.sub || filter.sub || ( (defaults?.group || filter.group) === "Pediatrics" ? "URI" : "" ),

      title: "", alias: "", body: ""

    };

    current = data.find(x=>x.id===id) || blank;

    $("#edTitle").textContent = current.id ? "Edit Macro" : "New Macro";

    populateGroupOptions();

    $("#fGroup").value=current.group || Object.keys(categories)[0];

    populateSubSuggestions($("#fGroup").value);

    $("#fSub").value=current.sub || "";

    updateAliasPrefix();

    const pref = prefixForGroup($("#fGroup").value);

    const suffix = (current.alias||"").toLowerCase().startsWith(pref)

      ? (current.alias||"").slice(pref.length)

      : "";

    $("#fAliasSuffix").value = suffix;

    $("#fTitle").value=current.title||"";

    $("#fBody").value=current.body||"";

    $("#fGroup").onchange = ()=>{

      populateSubSuggestions($("#fGroup").value);

      updateAliasPrefix();

    };

    editorDlg.showModal();

  }

  $("#closeEd").onclick=()=>editorDlg.close();

  $("#saveBtn").onclick=()=>{

    const group=$("#fGroup").value.trim();

    const sub=$("#fSub").value.trim();

    const title=$("#fTitle").value.trim();

    const suffix=($("#fAliasSuffix").value||"").trim().toLowerCase().replace(/\s+/g,'');

    const alias = prefixForGroup(group) + suffix;

    const body=$("#fBody").value;

    if(!group||!title||!suffix){toast("Group, Title & alias suffix required");return;}

    const m = current.id ? current : {id:rid()};

    Object.assign(m,{group,sub,title,alias,body});

    upsert(m); editorDlg.close(); renderSidebar(); renderList(); toast("Saved");

  };

  $("#delBtn").onclick=()=>{

    if(!current.id){editorDlg.close();return;}

    if(confirm("Delete this macro?")){

      data=data.filter(x=>x.id!==current.id); setAll(data); editorDlg.close(); renderSidebar(); renderList(); toast("Deleted");

    }

  };

  $("#dupBtn").onclick=()=>{

    const group=$("#fGroup").value||current.group;

    const suffix=($("#fAliasSuffix").value||"copy").replace(/\s+/g,'').toLowerCase();

    const m={...current,id:rid(),title:(current.title||"Untitled")+" (copy)",alias:prefixForGroup(group)+suffix};

    data.unshift(m); setAll(data); renderSidebar(); renderList(); toast("Duplicated");

  };

  function upsert(m){

    const i=data.findIndex(x=>x.id===m.id);

    if(i>=0) data[i]=m; else data.unshift(m);

    setAll(data);

  }

  /* ---------- Search: highlight + Next + Prev + dot-phrase ---------- */

  let hits=[],hitIdx=-1;

  const normalQuery=()=>{const q=(searchEl.value||"").trim();return q.startsWith(".")?"":q.toLowerCase();}

  function updateCounter(){ if(!hits.length){ hitCount.textContent=""; return; } hitCount.textContent = `${hitIdx>=0 ? hitIdx+1 : 0}/${hits.length}`; }

  function highlight(q){

    document.querySelectorAll(".card pre").forEach(p=>{

      p.innerHTML=p.textContent; if(!q) return;

      const r=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),"gi");

      p.innerHTML=p.innerHTML.replace(r,m=>`<mark>${m}</mark>`);

    });

    hits=[...document.querySelectorAll(".card mark")].map(m=>m.closest(".card").id.replace("card-",""));

    hitIdx=-1;

    updateCounter();

  }

  function gotoNext(){

    if(!hits.length) return;

    hitIdx = (hitIdx+1) % hits.length;

    const id = hits[hitIdx];

    const el = document.getElementById("card-"+id);

    el?.scrollIntoView({behavior:"smooth",block:"center"});

    el?.classList.add("hl"); setTimeout(()=>el?.classList.remove("hl"),1200);

    updateCounter();

  }

  function gotoPrev(){

    if(!hits.length) return;

    hitIdx = (hitIdx<=0 ? hits.length-1 : hitIdx-1);

    const id = hits[hitIdx];

    const el = document.getElementById("card-"+id);

    el?.scrollIntoView({behavior:"smooth",block:"center"});

    el?.classList.add("hl"); setTimeout(()=>el?.classList.remove("hl"),1200);

    updateCounter();

  }

  prevBtn.onclick = gotoPrev;

  nextBtn.onclick = gotoNext;

  searchEl.oninput=()=>renderList();

  searchEl.onkeydown=e=>{

    if(e.key==="Enter"){

      const q=searchEl.value.trim();

      if(q.startsWith(".")){

        const alias=q.slice(1).toLowerCase();

        const m=data.find(x=>{

          const inFilter=(filter.group==="All"||x.group===filter.group)&&(!filter.sub||x.sub===filter.sub);

          return inFilter && (x.alias||"").toLowerCase()===alias;

        });

        if(m){

          navigator.clipboard.writeText(m.body||"");

          toast("Copied");

          const card=document.getElementById("card-"+m.id);

          card?.scrollIntoView({behavior:"smooth",block:"center"});

          card?.classList.add("hl"); setTimeout(()=>card?.classList.remove("hl"),1200);

          hits=[m.id]; hitIdx=0; updateCounter();

        } else {

          toast("No alias match in this view");

        }

      } else {

        if(e.shiftKey){ gotoPrev(); } else { gotoNext(); }

      }

    } else if(e.key==="Escape"){ searchEl.value=""; renderList(); }

  };

  /* ---------- Settings ---------- */

  $("#settingsBtn").onclick=()=>{ renderSettings(); settingsDlg.showModal(); };

  $("#closeSettings").onclick=()=>settingsDlg.close();

  $("#addCatBtn").onclick=()=>addCatRow({name:"New Category", prefix:"new", color:"#0FA6A6"}, true);

  function renderSettings(){

    categories = getCategories();

    const container=$("#catRows");

    container.innerHTML="";

    Object.entries(categories).forEach(([name,info])=>{

      addCatRow({name, prefix:info.prefix, color:info.color});

    });

  }

  function addCatRow({name,prefix,color}, focus=false){

    const row=document.createElement("div");

    row.className="settings-grid";

    row.innerHTML=`

      <input class="input catName" value="${name}" aria-label="Category name">

      <input class="input catPre" value="${prefix}" aria-label="Prefix">

      <input class="input catCol" type="color" value="${toHex(color)}" aria-label="Color">

      <div class="row" style="justify-content:flex-end">

        <button class="btn danger delBtn">Delete</button>

      </div>

    `;

    $("#catRows").appendChild(row);

    const nameEl=row.querySelector(".catName");

    const preEl=row.querySelector(".catPre");

    const colEl=row.querySelector(".catCol");

    const delBtn=row.querySelector(".delBtn");

    if(focus) nameEl.select();

    const commit=()=>{

      const oldName=name;

      const newName=nameEl.value.trim()||oldName;

      const newPrefix=(preEl.value||"").trim().toLowerCase().replace(/\s+/g,'')||"other";

      const newColor=colEl.value||"#9ab7e6";

      const cats=getCategories();

      if(newName!==oldName){

        cats[newName]={ color:newColor, prefix:newPrefix };

        if(cats[oldName]) delete cats[oldName];

        data = getAll().map(m=> m.group===oldName ? {...m, group:newName} : m);

        setAll(data);

        name=newName;

      } else {

        cats[newName]={ color:newColor, prefix:newPrefix };

      }

      setCategories(cats);

      categories=cats;

      renderSidebar();

      renderList();

    };

    nameEl.onchange=commit;

    preEl.onchange=commit;

    colEl.onchange=commit;

    delBtn.onclick=()=>{

      if(!confirm(`Delete category "${name}"? Macros will move to "Other".`)) return;

      const cats=getCategories();

      if(name in cats) delete cats[name];

      setCategories(cats);

      categories=cats;

      data=getAll().map(m=> m.group===name ? {...m, group:"Other"} : m);

      setAll(data);

      row.remove();

      renderSidebar();

      renderList();

    };

  }

  function toHex(c){ const ctx=document.createElement("canvas").getContext("2d"); ctx.fillStyle=c; const v=ctx.fillStyle; return v.startsWith("#")?v:"#9ab7e6"; }

  /* ---------- Boot ---------- */

  function load(){

    seedIfEmpty();

    data = migrate(getAll());

    categories = getCategories();

    renderSidebar();

    renderList();

  }

})();
// Enable Enter key to submit login
document.addEventListener("DOMContentLoaded", () => {
  const user = document.querySelector('input[type="text"]');
  const pass = document.querySelector('input[type="password"]');
  const btn = document.querySelector('button, input[type="submit"], [onclick*="signin"], [onclick*="login"]');

  [user, pass].forEach(el => {
    if (!el) return;
    el.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        btn?.click();
      }
    });
  });
});

</script>

</body>

</html>
